"""Table-driven property interpolation used by the Fortran-inspired model."""

from __future__ import annotations

from typing import Dict, List, Tuple


def _interp(points_x: List[float], points_y: List[float], x: float) -> float:
    if not points_x or len(points_x) != len(points_y):
        raise ValueError("invalid interpolation table")

    if x <= points_x[0]:
        return float(points_y[0])
    if x >= points_x[-1]:
        return float(points_y[-1])

    upper = 1
    while points_x[upper] < x:
        upper += 1
    lower = upper - 1
    x1 = points_x[lower]
    x2 = points_x[upper]
    y1 = points_y[lower]
    y2 = points_y[upper]
    span = x2 - x1
    frac = 0.0 if span <= 1.0e-12 else (x - x1) / span
    return float(y1 + frac * (y2 - y1))


# Ported from docs/python_early_version/unbar.py.
TABLE_DATA: Dict[str, Tuple[List[float], List[float]]] = {
    "TVAP": (
        [50.0, 100.0, 150.0, 200.0, 250.0, 300.0, 350.0, 400.0, 450.0, 500.0, 550.0, 600.0, 650.0, 700.0, 750.0, 800.0, 850.0, 900.0, 950.0, 1000.0],
        [770.0, 820.0, 855.0, 880.0, 905.0, 925.0, 945.0, 965.0, 980.0, 995.0, 1010.0, 1025.0, 1035.0, 1050.0, 1060.0, 1070.0, 1080.0, 1090.0, 1100.0, 1110.0],
    ),
    "DELHV": (
        [180.0, 360.0, 534.6, 540.0, 720.0, 900.0, 1080.0],
        [1390.16, 1332.82, 1280.02, 1279.12, 1237.79, 1208.80, 1189.76],
    ),
    "DELHL": (
        [180.0, 360.0, 534.6, 540.0, 720.0, 900.0, 1080.0],
        [652.14, 665.96, 679.61, 679.89, 700.89, 733.19, 777.22],
    ),
    "ZTBLA": (
        [0.0, 0.0055, 0.0111, 0.0167, 0.0168, 0.0439, 0.0575, 0.0711, 0.0847, 0.0983, 0.1119, 0.1255, 0.1391, 0.1527, 0.1663, 0.1799, 0.1935, 0.2207, 0.2343, 0.2500],
        [0.001, 0.001, 0.001, 0.001, 0.0064, 0.0064, 0.0064, 0.0064, 0.0064, 0.0064, 0.0064, 0.0064, 0.0064, 0.0064, 0.0064, 0.0064, 0.0064, 0.0064, 0.0064, 0.0064],
    ),
    "ZTBLAP": (
        [0.0, 0.0055, 0.0111, 0.0167, 0.0168, 0.0439, 0.0575, 0.0711, 0.0847, 0.0983, 0.1119, 0.1255, 0.1391, 0.1527, 0.1663, 0.1799, 0.1935, 0.2207, 0.2343, 0.2500],
        [2100.0, 2100.0, 2100.0, 2100.0, 330.0, 330.0, 330.0, 330.0, 330.0, 330.0, 330.0, 330.0, 330.0, 330.0, 330.0, 330.0, 330.0, 330.0, 330.0, 330.0],
    ),
    "ZTBLD": (
        [0.0, 0.0055, 0.0111, 0.0167, 0.0168, 0.0439, 0.0575, 0.0711, 0.0847, 0.0983, 0.1119, 0.1255, 0.1391, 0.1527, 0.1663, 0.1799, 0.1935, 0.2207, 0.2343, 0.2500],
        [0.34, 0.34, 0.34, 0.34, 0.34, 0.34, 0.34, 0.34, 0.34, 0.34, 0.34, 0.34, 0.34, 0.34, 0.34, 0.34, 0.34, 0.34, 0.34, 0.34],
    ),
    "TBLVP": (
        [492.0, 519.0, 528.37, 529.08, 534.60, 534.71, 538.84, 543.91, 545.73, 560.20, 569.98, 579.26, 579.48, 595.34, 610.13, 614.08, 618.07, 627.49, 628.82, 645.68, 650.76, 665.57, 674.99, 686.13, 692.39, 697.47, 744.0, 798.0, 852.0, 942.0, 1032.0, 1122.0, 1176.0],
        [0.0520, 0.1479, 0.2011, 0.2069, 0.2398, 0.2436, 0.2823, 0.2920, 0.3539, 0.5453, 0.7367, 0.9727, 0.9823, 1.510, 2.204, 2.462, 2.740, 3.407, 3.562, 5.240, 5.971, 8.065, 9.711, 11.91, 13.46, 14.70, 33.80, 73.48, 147.0, 382.1, 823.0, 1528.0, 2131.0],
    ),
    "TBLH4": (
        [0.0, 180.0, 360.0, 536.4, 540.0, 720.0, 900.0, 1080.0, 1260.0, 1440.0, 1620.0, 1800.0, 1980.0, 2160.0, 2340.0, 2520.0, 2700.0, 2880.0, 3060.0],
        [-1991.34, -1951.02, -1919.50, -1896.04, -1895.70, -1882.55, -1878.12, -1879.46, -1884.63, -1892.38, -1901.94, -1912.88, -1924.85, -1937.54, -1950.74, -1964.45, -1978.32, -1992.36, -2006.62],
    ),
    "TBLH3": (
        [0.0, 180.0, 360.0, 536.4, 540.0, 720.0, 900.0, 1080.0, 1260.0, 1440.0, 1620.0, 1800.0, 1980.0, 2160.0, 2340.0, 2520.0, 2700.0, 2880.0, 3060.0],
        [983.07, 1055.57, 1103.97, 1159.35, 1160.40, 1213.46, 1259.64, 1298.00, 1329.71, 1355.28, 1375.67, 1391.11, 1402.52, 1410.13, 1414.57, 1416.37, 1416.05, 1414.15, 1410.56],
    ),
    "SHTBL1": (
        [540.0, 720.0, 900.0, 1080.0, 1260.0, 1440.0, 1620.0, 1800.0, 1980.0, 2160.0, 2340.0, 2520.0, 2700.0, 2880.0, 3060.0],
        [0.3084, 0.4601, 0.5261, 0.5784, 0.6212, 0.6577, 0.6899, 0.7185, 0.7442, 0.7673, 0.7879, 0.8063, 0.8226, 0.8373, 0.8503],
    ),
    "SHTBL2": (
        [540.0, 720.0, 900.0, 1080.0, 1260.0, 1440.0, 1620.0, 1800.0, 1980.0, 2160.0, 2340.0, 2520.0, 2700.0, 2880.0, 3060.0],
        [0.5005, 0.5424, 0.5891, 0.6344, 0.6773, 0.7176, 0.7553, 0.7905, 0.8236, 0.8541, 0.8823, 0.9075, 0.9304, 0.9512, 0.9697],
    ),
    "SHTBL3": (
        [540.0, 720.0, 900.0, 1080.0, 1260.0, 1440.0, 1620.0, 1800.0, 1980.0, 2160.0, 2340.0, 2520.0, 2700.0, 2880.0, 3060.0],
        [0.2485, 0.2495, 0.2524, 0.2569, 0.2624, 0.2682, 0.2738, 0.2790, 0.2836, 0.2878, 0.2914, 0.2946, 0.2974, 0.2998, 0.3019],
    ),
    "SHTBL4": (
        [540.0, 720.0, 900.0, 1080.0, 1260.0, 1440.0, 1620.0, 1800.0, 1980.0, 2160.0, 2340.0, 2520.0, 2700.0, 2880.0, 3060.0],
        [3.4194, 3.4596, 3.4685, 3.4765, 3.4899, 3.5151, 3.5454, 3.5806, 3.6208, 3.6654, 3.7150, 3.7696, 3.8291, 3.8802, 3.9288],
    ),
    "VISVST": (
        [360.0, 540.0, 720.0, 900.0, 1080.0, 1260.0, 1440.0, 1620.0, 1800.0, 1980.0, 2160.0, 2340.0, 2520.0],
        [0.048e-4, 0.070e-4, 0.093e-4, 0.117e-4, 0.141e-4, 0.164e-4, 0.186e-4, 0.207e-4, 0.220e-4, 0.247e-4, 0.266e-4, 0.285e-4, 0.302e-4],
    ),
    "CFTBL4": (
        [540.0, 720.0, 900.0, 1080.0, 1260.0, 1440.0, 1620.0, 1800.0, 1980.0, 2160.0, 2340.0, 2520.0, 2700.0, 2880.0, 3060.0],
        [0.3604, 0.4601, 0.5261, 0.5704, 0.6212, 0.6577, 0.6899, 0.7185, 0.7442, 0.7673, 0.7879, 0.8063, 0.8226, 0.8373, 0.8503],
    ),
    "CFTBL3": (
        [540.0, 720.0, 900.0, 1080.0, 1260.0, 1440.0, 1620.0, 1800.0, 1980.0, 2160.0, 2340.0, 2520.0, 2700.0, 2880.0, 3060.0],
        [0.5005, 0.5424, 0.5891, 0.6344, 0.6773, 0.7176, 0.7553, 0.7905, 0.8236, 0.8541, 0.8823, 0.9075, 0.9304, 0.9512, 0.9697],
    ),
    "CFTBL2": (
        [540.0, 720.0, 900.0, 1080.0, 1260.0, 1440.0, 1620.0, 1800.0, 1980.0, 2160.0, 2340.0, 2520.0, 2700.0, 2880.0, 3060.0],
        [0.2485, 0.2495, 0.2524, 0.2569, 0.2624, 0.2681, 0.2738, 0.2790, 0.2836, 0.2878, 0.2914, 0.2946, 0.2974, 0.2998, 0.3019],
    ),
    "CFTBL1": (
        [540.0, 720.0, 900.0, 1080.0, 1260.0, 1440.0, 1620.0, 1800.0, 1980.0, 2160.0, 2340.0, 2520.0, 2700.0, 2880.0, 3060.0],
        [3.4194, 3.4596, 3.4685, 3.4765, 3.4899, 3.5151, 3.5454, 3.5806, 3.6208, 3.6654, 3.7150, 3.7696, 3.8291, 3.8802, 3.9288],
    ),
    "DHVST": (
        [180.0, 360.0, 534.6, 540.0, 720.0, 900.0, 1080.0],
        [1390.16, 1332.82, 1280.2, 1279.12, 1237.79, 1208.80, 1189.76],
    ),
    "DHLVST": (
        [180.0, 360.0, 534.6, 540.0, 720.0, 900.0, 1080.0],
        [652.14, 665.96, 679.61, 679.89, 700.89, 733.19, 777.22],
    ),
}


def unbar(table: str, value: float) -> float:
    key = table.strip().upper()
    if key == "H4TBL":
        key = "TBLH4"
    if key == "H3TBL":
        key = "TBLH3"
    if key not in TABLE_DATA:
        raise KeyError(f"unknown table '{table}'")
    x_values, y_values = TABLE_DATA[key]
    return _interp(x_values, y_values, float(value))
