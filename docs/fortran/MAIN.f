C ***********************************************************************
C
C  DESCRIPTION OF INPUT DATA PUNCH CARDS FOLLOWS ...
C
C                                                                FORMAT
C  CARD  1     COL'S 1-3   CONTAIN NCASE  (ONLY ONE CARD 1       (13)
C                                          PER RUN)
C
C                                         (CARDS 2 THRU 16 
C                                          SHOULD BE REPEATED
C                                          FOR EACH DATA CASE)
C
C  CARD  2     COL'S  1-80  TITLE CARD - ANY ALPHANUMERIC        (14A6)
C                                        INFORMATION DESIRED
C
C  CARD  3     COL'S  1-2   CONTAIN OPTION                       (12)
C              COL'S  3-4   CONTAIN PRINT                        (12)
C              COL'S  5-7   CONTAIN NOFZ                         (13)
C
C  CARD  4     COL'S  1-10  CONTAIN Z0 ......................... (E10.5)
C              COL'S 11-20  CONTAIN G0 ......................... (E10.5)
C              COL'S 21-30  CONTAIN FC ......................... (E10.5)
C              COL'S 31-40  CONTAIN ALPHA3 ..................... (E10.5)
C              COL'S 41-50  CONTAIN HF ......................... (E10.5)
C              COL'S 51-60  CONTAIN R .......................... (E10.5)
C              COL'S 61-70  CONTAIN WM4 ........................ (E10.5)
C              COL'S 71-80  CONTAIN WM3 ........................ (E10.5)
C
C  CARD 5      COL'S  1-10  CONTAIN WM2 ........................ (E10.5)
C              COL'S 11-20  CONTAIN WM1 ........................ (E10.5)
C              COL'S 21-30  CONTAIN ALPHA1 ..................... (E10.5)
C              COL'S 31-40  CONTAIN ALPHA2 ..................... (E10.5)
C              COL'S 41-50  CONTAIN AGM ........................ (E10.5)
C              COL'S 51-60  CONTAIN BGM ........................ (E10.5)
C              COL'S 61-70  CONTAIN KP ......................... (E10.5)
C              COL'S 71-80  CONTAIN CGM ........................ (E10.5)
C
C  CARD 6      COL'S  1-10  CONTAIN TF ......................... (E10.5)
C              COL'S 11-20  CONTAIN CFL ........................ (E10.5)
C              COL'S 21-30  CONTAIN ENMX1 ...................... (E10.5)
C              COL'S 31-40  CONTAIN ENMX2 ...................... (E10.5)
C              COL'S 41-50  CONTAIN ENMX3 ...................... (E10.5)
C              COL'S 51-60  CONTAIN DIF3 ....................... (E10.5)
C              COL'S 61-70  CONTAIN DIF4 ....................... (E10.5)
C              COL'S 71-80  CONTAIN PRES ....................... (E10.5)
C
C  CARD 7      COL'S  1-10  CONTAIN ZEND ....................... (E10.5)
C              COL'S 11-20  CONTAIN EN1 ........................ (E10.5)
C              COL'S 21-30  CONTAIN EN2 ........................ (E10.5)
C              COL'S 31-40  CONTAIN EN3 ........................ (E10.5)
C
C             (THE TABLE FOR CATALYST PARTICLE RADIUS VS
C              AXIAL DISTANCE ALONG REACTOR BED FOLLOWS)
C
C  CARD  8     COL'S   1-8  CONTAIN THE NUMBER 0.0               (E8.4)
C              COL'S  9-16  CONTAIN THE NUMBER 1.0               (E8.4)
C              COL'S 17-24  CONTAIN NOFZ (FLOATING POINT)        (E8.4)
C              COL'S 25-32  CONTAIN THE NUMBER 0.0               (E8.4)
C
C  CARDS 9A,9B,...          CONTAIN THE AXIAL STATION Z VALUES
C                           Z(1),Z(2),...,Z(NOFZ)
C                           10 PER CARD, COL'S 1-80 ........... (10E8.4)
C
C CARDS 10A,10B,...    CONTAIN THE CATALYST PARTICLE RADII
C                     A(1),A(2),....,A(NOFZ)
C                     10 PER CARD COL'S 1-80               (10E8.4)
C
C     (THE TABLE FOR CATALYST PARTICLE SURFACE AREA
C      VS AXIAL DISTANCE ALONG REACTOR BED FOLLOWS)
C
C CARD 11             THIS CARD IS IDENTICAL TO CARD 8
C
C CARDS 12A,12B,...    THESE CARDS (OR SINGLE CARD) ARE IDENTICAL
C                     TO CARDS 9A,9B...
C
C CARDS 13A,13B,...    CONTAIN THE CATALYST PARTICLE SURFACE AREAS
C                     AP(1),AP(2),....,AP(NOFZ)
C                     10 PER CARD, COL'S 1-80               (10E8.4)
C
C     (THE TABLE FOR INTERPARTICLE VOID FRACTION VS
C      AXIAL DISTANCE ALONG REACTOR BED FOLLOWS)
C
C CARD 14             THIS CARD IS IDENTICAL TO CARD 8
C
C CARDS 15A,15B,...    THESE CARDS (OR SINGLE CARD) ARE IDENTICAL
C                     TO CARDS 9A,9B...
C
C CARDS 16A,16B,...    CONTAIN THE INTERPARTICLE VOID FRACTIONS
C                     DELA(1),DELA(2),....,DELA(NOFZ)
C                     10 PER CARD, COL'S 1-80 .............. (10E8.4)
C
      REAL KP,K
      INTEGER OPTION,PRINT
      COMMON /FTZ/TBLVP(70),TBLH4(42),TBLH3(42),SHTBL1(34),SHTBL2(34),
     1        SHTBL3(34),SHTBL4(34),ZTBLD(46),ZTBLAP(46),ZTBLA(46)
      COMMON /CO/HL,HV,FC,TF,CFL,CGM,ENMX1,AGM,DIF3,DIF4,KP,PRES,GO,
     1        WM4,WM3,WM2,WM1,ALPHA3,R,TVAP,ZEND,BGM,HF,DZ,ALPHA1,ALPHA2
     2        ,ENMX2,ENMX3,EN1,EN2,EN3,H,RAT,MI
      COMMON /VAR/DERIV(250),DHDZ(250),Z(250)
      COMMON /TOLL/ALIM,OPTION,C1,C2,C3,C4,CAV,G,TEMP,AP,WMAV,ZO,
      COMMON /MUVST/VISVST(30)
      COMMON /FLAGS/MFLAG,KFLAG,PRINT
      COMMON /IFCEQ0/IFC,GATZ0
      COMMON /LIZTBL/DHVST(18),DHLVST(18)
      COMMON /DAVTBL/VPTBL(44)
      DIMENSION  TITLE(14)
      READ (5,700) NCASE
  700 FORMAT (13)
      KOUNT=1
  705 READ (5,608) TITLE
  608 FORMAT (14A6)
      WRITE (6,609) TITLE
  609 FORMAT (1H1,14A6//)
      IFC=1
      READ (5,809) OPTION,PRINT,NOFZ
  809 FORMAT (212,13)
      READ (5,800) ZO,GO,FC,ALPHA3,HF,R,WM4,WM3,WM2,WM1,ALPHA1,ALPHA2
     A,AGM,BGM,KP,CGM,TF,CFL,ENMX1,ENMX2,ENMX3,DIF3,DIF4,PRES,ZEND,
     B EN1,EN2,EN3
  800 FORMAT (8E10.5)
      NZTBL=2*NOFZ+4
      NOFZ4=NOFZ+4
      NOFZ5=NOFZ4+1
      CALL UNBAR (VPTBL(1),1,PRES,0.,TVAP,KK)
      CALL UNBAR (DHVST(1),1,TVAP,0.,DELHV,KK)
      CALL UNBAR (DHLVST(1),1,TVAP,0.,DELHL,KK)
      HL=HF+(TVAP-TF)*CFL
      HV=HL+DELHV-DELHL
      GATZO=GO+FC*ZO
      IF(FC.GT.0.) GO TO 637
      IFC=0
  637 WRITE (6,600)
  600 FORMAT (52X,16H INPUT CONSTANTS/7X,2HHL,10X,2HHV,10X,2HTF,
     1 9X,4HTVAP,8X,3HCFL,8X,8HPRESSURE,5X,2HKP,10X,1HFC,10X,
     2 2HGO)
      WRITE (6,601) HL,HV,TF,TVAP,CFL,PRES,KP,FC,GO
  601 FORMAT (3X,10E11.4//)
      WRITE (6,602)
  602 FORMAT (7X,1HR,9X,6HALPHA3,6X,3HCGM,8X,4HDIF3,7X,4HDIF4,7X,
     1 3HWM4,8X,3HWM3,8X,3HWM2,8X,3HWM1,7X,4HZEND)
      WRITE (6,601) R,ALPHA3,CGM,DIF3,DIF4,WM4,WM3,WM2,WM1,ZEND
      WRITE (6,603)
  603 FORMAT (7X,3HAGM,8X,3HBGM,8X,6HALPHA1,5X,6HALPHA2,6X,2HN1,
     1 9X,2HN2,9X,2HN3,8X,5HENMX1,6X,5HENMX2,6X,5HENMX3)
      WRITE (6,601) AGM,BGM,ALPHA1,ALPHA2,EN1,EN2,EN3,ENMX1,ENMX2,ENMX3
      WRITE (6,617) ZO
  617 FORMAT (//7X,2HZO,E11.4)
      READ (5,20) (ZTBLA(I),I=1,4)
   20 FORMAT (4E8.4)
      READ (5,21) (ZTBLA(I),I=5,NOFZ4)
   21 FORMAT (10E8.4)
      READ (5,21) (ZTBLA(I),I=NOFZ5,NZTBL)
      READ (5,20) (ZTBLAP(I),I=1,4)
      READ (5,21) (ZTBLAP(I),I=5,NOFZ4)
      READ (5,21) (ZTBLAP(I),I=NOFZ5,NZTBL)
      READ (5,20) (ZTBLD(I),I=1,4)
      READ (5,21) (ZTBLD(I),I=5,NOFZ4)
      READ (5,21) (ZTBLD(I),I=NOFZ5,NZTBL)
      WRITE (6,23)
   23 FORMAT (///55X,13H Z VS A TABLE)
      WRITE (6,22) (ZTBLA(I),I=1,4)
   22 FORMAT (46X,4E13.5)
      WRITE (6,25) (ZTBLA(I),I=5,NOFZ4)
   25 FORMAT (1X,10E13.5)
      WRITE (6,25) (ZTBLA(I),I=NOFZ5,NZTBL)
      WRITE (6,24)
   24 FORMAT (///54X,14H Z VS AP TABLE)
      WRITE (6,22) (ZTBLAP(I),I=1,4)
      WRITE (6,25) (ZTBLAP(I),I=5,NOFZ4)
      WRITE (6,25) (ZTBLAP(I),I=NOFZ5,NZTBL)
      WRITE (6,607)
  607 FORMAT (//52X,17H Z VS DELTA TABLE)
      WRITE (6,22) (ZTBLD(I),I=1,4)
      WRITE (6,25) (ZTBLD(I),I=5,NOFZ4)
      WRITE (6,25) (ZTBLD(I),I=NOFZ5,NZTBL)
  613 WRITE (6,850)
  850 FORMAT (1H0,49X,30HENTERING LIQUID REGION
     1  //39X,4H Z  ,12X,4HTEMP,11X,1HH,11X,4HDHDZ)
      Z(1)=0.0
      H=HL
      II=1
  875 II=II+1
  850 Z(II)=Z(II-1)+DZ
      TEMP=TF+(H-HF)/CFL
      CALL UNBAR (TBLVP(1),1,TEMP,0.,VP,KK)
      C4=(VP*WM4)/(R*TEMP)
      CALL UNBAR (TBLH4(1),1,TEMP,0.,H4,KK)
      CALL UNBAR (ZTBLAP(1),1,Z(II),0.,AP,KK)
      CALL UNBAR (ZTBLA(1),1,Z(II),0.,A,KK)
      CALL PARAM (TEMP,Z(II),1,C4,H4,0.,GGMMA,K,DPA,BETA)
      CALL SLOPE (C4,GGMMA,K,BETA,EN1,DERIV(II),DPA,A,DIF4)
      IF (H.LT.HL) 777,770,777
  770 DERIV(II)=DERIV(II-1)
  777 DHDZ(II)=(H4*DPA*AP*DERIV(II)+FC*(H-HF))/G
      DZ=-H4/(ENMX1*DHDZ(II))
      IF (DZ.LE.0.) DZ=Z(II)*2.
  860 WRITE (6,800) Z(II),TEMP,H,DHDZ(II)
  800 FORMAT (30X,4E15.6)
      IF (H-HL) 874,1020,874
  874 H=H+DHDZ(II)*DZ
      IF (H-HL) 875,1020,1000
C     BACKSTEP TO L-LV-BOUNDARY
 1000 DZ=(HL-H)/DHDZ(II)+DZ
      H=HL
      II=II+1
      GO TO 850
 1020 IF (OPTION.EQ.2) CALL LQV2 (H,Z(II),DERIV(II),II,DHDZ(II),TEMP)
      IF (OPTION.EQ.2) GO TO 1021
      CALL LQVP (H,Z(II),DERIV(II),II,DHDZ(II),TEMP)
C     START VAPOR REGION
 1021 DZ=-H4/(ENMX3*DHDZ(II))
      CALL VAPOR (TEMP,Z(II),DERIV(II),H,C1,C2,C3,C4)
      KOUNT=KOUNT+1
      IF(KOUNT.LE.NCASE) GO TO 705
      WRITE (6,102)
  102 FORMAT (////41H ***** OPERATIONS COMPLETE *****)
      STOP
      END

      SUBROUTINE LQVP (H,ZLV,Q,JJ,Q1,TEMP)
      REAL KP,K
      INTEGER PRINT
      COMMON /FTZ/TBLVP(70),TBLH4(42),TBLH3(42),SHTBL1(34),SHTBL2(34),
     1 SHTBL3(34),SHTBL4(34),ZTBLD(46),ZTBLAP(46),ZTBLA(46)
      COMMON /CO/HL,HV,FC,TF,CFL,CGM,ENMX1,AGM,DIF3,DIF4,KP,PRES,GO,
     1 WM4,WM3,WM2,WM1,ALPHA3,R,TVAP,ZEND,BGM,HF,DZ,ALPHA1,ALPHA2,
     2 ENMX2,ENMX3,EN1,EN2,EN3,H,RAT,MI
      COMMON /VAR/DERIV(250),DHDZ(250),Z(250)
      COMMON /TOLL/ALIM,OPTION,C1,C2,C3,C4,CAVG,TEMP,AP,WMAV,ZO,
      COMMON /MUVST/VISVST(30)
      COMMON /FLAGS/MFLAG,KFLAG,PRINT
      WRITE(6,100)
  100 FORMAT (109H1 ****************************** ENTERING L
     1IQUID-VAPOR REGION     ****************************** //)
      DERIV(JJ)=Q
      DHDZ(JJ)=Q1
      WRITE (6,1750)
 1750 FORMAT (//30X,3H Z ,11X,5H TEMP,11X,1HH,12X,3HWFV)
 1800 Z(JJ)=ZLV
      JJ=JJ+1
      GO TO 1820
 3101 CONTINUE
 1820 DERIV(JJ)=DERIV(JJ-1)
      Z(JJ)=Z(JJ-1)+DZ
      TEMP=TVAP
      CALL UNBAR (TBLH4(1),1,TEMP,0.,H4,KK)
      CALL UNBAR (ZTBLAP(1),1,Z(JJ),0.,AP,KK)
      CALL PARAM (TEMP,Z(JJ),1,0.,0.,0.,0.,GGMMA,K,DPA,BETA)
      DHDZ(JJ)=(H4*DPA*AP*DERIV(JJ)+FC*(H-HF))/G
      DZ=-H4/(ENMX2*DHDZ(JJ))
      IF (H-HV) 32,1850,32
   32 H=H+DHDZ(JJ)*DZ
      IF (H-HL) 1850,1850,1650
 1650 WFV=(H-HL)/(HV-HL)
      WRITE (6,1900) Z(JJ),TEMP,H,WFV
 1900 FORMAT (22X,E14.5,1X,E14.5,1X,E14.5,1X,E14.5)
      IF (H-HV) 33,1850,33
   33 GO TO 1800
 2000 DZ=(HV-H)/DHDZ(JJ)+DZ
      H=HV
      JJ=JJ+1
      Z(JJ)=Z(JJ-1)+DZ
 1850 RETURN
      END

      SUBROUTINE LQV2 (H,ZLV,Q,JJ,Q1,CN2H4)
      INTEGER PRINT
      COMMON /FTZ/TBLVP(70),TBLH4(42),TBLH3(42),SHTBL1(34),SHTBL2(34),
     1 SHTBL3(34),SHTBL4(34),ZTBLD(46),ZTBLAP(46),ZTBLA(46)
      COMMON /CO/HL,HV,FC,TF,CFL,CGM,ENMX1,AGM,DIF3,DIF4,KP,PRES,GO,
     1 WM4,WM3,WM2,WM1,ALPHA3,R,TVAP,ZEND,BGM,HF,DZ,ALPHA1,ALPHA2,
     2 ENMX2,ENMX3,EN1,EN2,EN3,H,RAT,MI
      COMMON /VAR/DERIV(250),DHDZ(250),Z(250)
      COMMON /TOLL/ALIM,OPTION,C1,C2,C3,C4,CAVG,TEMP,AP,WMAV,ZO,
      COMMON /MUVST/VISVST(30)
      COMMON /FLAGS/MFLAG,KFLAG,PRINT
      WRITE (6,100)
  100 FORMAT (109H1 ****************************** ENTERING L
     1IQUID-VAPOR REGION     ****************************** //)
      WFV=0.
      DERIV(JJ)=Q
      DHDZ(JJ)=Q1
      Z(JJ)=ZLV
      CALL UNBAR (TBLH4(1),1,TEMP,0.,H4,KK)
      C4=CN2H4*((H4*WFV+HL)/(H4+HL-H))
      GO TO 1820
 3101 CONTINUE
 1820 Z(JJ)=Z(JJ-1)+DZ
      TEMP=TVAP
      CALL UNBAR (TBLH4(1),1,TEMP,0.,H4,KK)
      CALL UNBAR (ZTBLAP(1),1,Z(JJ),0.,AP,KK)
      CALL UNBAR (ZTBLA(1),1,Z(JJ),0.,A,KK)
      CALL PARAM (TEMP,Z(JJ),1,0.,0.,0.,0.,GGMMA,K,DPA,BETA)
      IF (MFLAG.EQ.1) GO TO 7
      CALL SLOPE (C4,GGMMA,K,BETA,EN1,DERIV(JJ),DPA,A,DIF4)
      GO TO 14
    7 DIFN=DIF4*((TEMP/492.)**1.823)*14.7/PRES
      CALL UNBAR (VISVST(1),1,TEMP,0.,VIS,KK)
      RHO=PRES*WM4/(R*TEMP)
      AKC=.616/RHO*((VIS/(RHO*DIFN))**-.667)*((G/(AP*VIS))**-.41)
      DERIV(JJ)=AKC*C4/DPA
   14 DERIV(JJ)=(1.-WFV)+DERIV(JJ)*WFV
      DHDZ(JJ)=(H4*DPA*AP*DERIV(JJ)+FC*(H-HF))/G
      DZ=-H4/(ENMX2*DHDZ(JJ))
      IF (H-HV) 15,3050,15
   15 H=H+DHDZ(JJ)*DZ
      IF (H-HV) 3050,3050,3500
 3050 WFV=(H-HL)/(HV-HL)
      XLV=(HF-H)/H4
      C4=PRES*WM4/(R*TEMP)*((1.-XLV)/(1.+XLV))
   16 GO TO 3100
 3500 DZ=(HV-H)/DHDZ(JJ)+DZ
      H=HV
      GO TO 16
 3000 FORMAT (//30X,3HZ,11X,5HTEMP,11X,1HH,12X,3HWFV)
      WRITE (6,3100) Z(JJ),TEMP,H,WFV
 3100 FORMAT (22X,E14.5,1X,E14.5,1X,E14.5,1X,E14.5////)
      IF (H-HV) 16,3150,16
 3150 RETURN
      END

C
C     THIS ROUTINE CALCULATES INITIAL N2H4,NH3,N2,H2 CONCENTRATIONS FOR
C     VAPOR REGION OF THE REACTOR BED
C
      SUBROUTINE CONC (C1,C2,C3,C4,ZC,H,T)
      INTEGER PRINT
      COMMON /FTZ/TBLVP(70),TBLH4(42),TBLH3(42),SHTBL1(34),SHTBL2(34),
     1 SHTBL3(34),SHTBL4(34),ZTBLD(46),ZTBLAP(46),ZTBLA(46)
      COMMON /CO/HL,HV,FC,TF,CFL,CGM,ENMX1,AGM,DIF3,DIF4,KP,PRES,GO,
     1 WM4,WM3,WM2,WM1,ALPHA3,R,TVAP,ZEND,BGM,HF,DZ,ALPHA1,ALPHA2,
     2 ENMX2,ENMX3,EN1,EN2,EN3,H,RAT,MI
      COMMON /VAR/DERIV(250),DHDZ(250),Z(250)
      COMMON /TOLL/ALIM,OPTION,C1,C2,C3,C4,CAVG,TEMP,AP,WMAV,ZO,
      COMMON /MUVST/VISVST(30)
      COMMON /FLAGS/MFLAG,KFLAG,PRINT
      CALL UNBAR (TBLH4(1),1,T,0.,H4,KK)
      XV=(H-HF)/H4
      C4=((PRES*WM4)/(R*TVAP))*((1.-XV)/(1.+XV))
      C3=((PRES*WM3)/(R*TVAP))*(XV/(1.+XV))
      C2=((PRES*WM2)/(2.*R*TVAP))*(XV/(1.+XV))
      C1=((PRES*WM1)/(2.*R*TVAP))*(XV/(1.+XV))
      RETURN
      END

      SUBROUTINE PARAM (T,ZA,LOP,C,H,LVOP,GGMMA,K,DPA,BETA)
      REAL KP,K
      INTEGER PRINT
      COMMON /FTZ/TBLVP(70),TBLH4(42),TBLH3(42),SHTBL1(34),SHTBL2(34),
     1 SHTBL3(34),SHTBL4(34),ZTBLD(46),ZTBLAP(46),ZTBLA(46)
      COMMON /CO/HL,HV,FC,TF,CFL,CGM,ENMX1,AGM,DIF3,DIF4,KP,PRES,GO,
     1 WM4,WM3,WM2,WM1,ALPHA3,R,TVAP,ZEND,BGM,HF,DZ,ALPHA1,ALPHA2,
     2 ENMX2,ENMX3,EN1,EN2,EN3,H,RAT,MI
      COMMON /VAR/DERIV(250),DHDZ(250),Z(250)
      COMMON /TOLL/ALIM,OPTION,C1,C2,C3,C4,CAVG,TEMP,AP,WMAV,ZO,
      COMMON /MUVST/VISVST(30)
      COMMON /FLAGS/MFLAG,KFLAG,PRINT
      COMMON /IFCEQ/IFC,GATZO
      IF(ZA-ZO) 43,48,48
   43 G=GO+FC*ZA
      GO TO 52
C     Z HAS EXCEEDED HYDRAZINE INJECTOR TUBE LENGTH - G CONSTANT FROM
C     HERE TO END OF BED
   48 G=GATZO
      FC=0.
   52 IF(LVOP.EQ.1) GO TO 1004
      GMMA=AGM/T
C     CALCULATE K,DPA FOR N2H4
      K=ALPHA1*EXP(-GMMA)
 1001 DPL=DIF4*((T/492.)**1.832)*(14.7/PRES)*(1.-EXP(-.0672*(PRES*492.)/(
     1 14.7*T)))
      DPA=DPL
 1002 BETA=(C*H*DPA)/(K*T)
      GO TO 1003
 1004 GMMA=BGM/T
C     CALCULATE K,DPA FOR NH3
      K=ALPHA2*EXP(-GMMA)/C1**1.0
      DPV=DIF3*(T/492.)**1.832*(14.7/PRES)*(1.-EXP(-.0672*(PRES*492.)/(
     1 14.7*T)))
      DPA=DPV
      GO TO 1002
 1003 RETURN
      END

      SUBROUTINE VAPOR (TEMP,ZV,Q,LL,Q1,QH)
      REAL KP,K
      REAL MUSS
      INTEGER PRINT
      COMMON /FTZ/TBLVP(70),TBLH4(42),TBLH3(42),SHTBL1(34),SHTBL2(34),
     1 SHTBL3(34),SHTBL4(34),ZTBLD(46),ZTBLAP(46),ZTBLA(46)
      COMMON /CO/HL,HV,FC,TF,CFL,CGM,ENMX1,AGM,DIF3,DIF4,KP,PRES,GO,
     1 WM4,WM3,WM2,WM1,ALPHA3,R,TVAP,ZEND,BGM,HF,DZ,ALPHA1,ALPHA2,
     2 ENMX2,ENMX3,EN1,EN2,EN3,H,RAT,MI
      COMMON /VAR/DERIV(250),DHDZ(250),Z(250)
      COMMON /TOLL/ALIM,OPTION,C1,C2,C3,C4,CAVG,TEMP,AP,WMAV,ZO,
      COMMON /MUVST/VISVST(30)
      COMMON /FLAGS/MFLAG,KFLAG,PRINT
      COMMON /IFCEQ/IFC,GATZO
      COMMON /BBDD/DP3,A,KC3,K0,X0A,CPS,CI3,GAMMA,BETA
      COMMON /CCC/M4TBL(41),M3TBL(40)
      COMMON /DDD/CFTBL4(34),CFTBL3(34),CFTBL2(34),CFTBL1(34)
      JZ=LL
      Z(LL)=ZV
      TEMP=TVAP
      PFRC3D=0.
      ZBOUND=ZEND
      NN=0
      JFLAG=0
      KOUNT=0
      INJECT=0
      MFLAG=1
      WRITE (6,100)
  100 FORMAT (109H1 ****************************** ENTERING
     1 VAPOR REGION     ****************************** //)
      CALL CONC (C1,C2,C3,C4,Z(LL),H,TEMP)
      SUM=C1/WM1+C2/WM2+C3/WM3+C4/WM4
      FRAC1=C1/(WM1*SUM)
      FRAC2=C2/(WM2*SUM)
      FRAC3=C3/(WM3*SUM)
      FRAC4=C4/(WM4*SUM)
      FRAC3D=(FRAC1/FRAC2-1.)/(3.-FRAC1/FRAC2)
      WRITE (6,4059)
      WRITE (6,4050) Z(LL),TEMP,PRES,H,C1,C2,C3,C4
      WRITE (6,37)
      WRITE (6,38) FRAC1,FRAC2,FRAC3,FRAC4,FRAC3D
      CALL UNBAR (SHTBL1(1),1,TEMP,0.,CP1,KK)
      CALL UNBAR (SHTBL2(1),1,TEMP,0.,CP2,KK)
      CALL UNBAR (SHTBL3(1),1,TEMP,0.,CP3,KK)
      CALL UNBAR (SHTBL4(1),1,TEMP,0.,CP4,KK)
      CAVG=(C4*CP4+C3*CP3+C2*CP2+C1*CP1)/(C4+C3+C2+C1)
      WMAV=(C1+C2+C3+C4)/(C1/WM1+C2/WM2+C3/WM3+C4/WM4)
      CALL UNBAR (TBLH4(1),1,TEMP,0.,H4,KK)
      CALL UNBAR (ZTBLD(1),1,Z(LL),0.,DELA,KK)
      CALL UNBAR (ZTBLAP(1),1,Z(LL),0.,AP,KK)
      CALL UNBAR (ZTBLA(1),1,Z(LL),0.,A,KK)
      CALL PARAM (TEMP,Z(LL),1,C4,H4,0.,GGMMA,K,DPA,BETA)
      IF (C4) 7,29,7
    7 DIFN=DIF4*((TEMP/492.)**1.823)*14.7/PRES
      CALL UNBAR (VISVST(1),1,TEMP,0.,VIS,KK)
      RHO=PRES*WMAV/(R*TEMP)
      AKC=.616/RHO*((VIS/(RHO*DIFN))**-.667)*((G/(AP*VIS))**-.41)
      DERIV(LL)=AKC*C4/DPA
      T4=AP*DPA*DERIV(LL)
      GO TO 31
   29 T4=0.
   31 CALL UNBAR (TBLH3(1),1,TEMP,0.,H3,KK)
      CALL PARAM (TEMP,Z(LL),1,C3,H3,1,GGMMA,K,DPA,BETA)
      IF (C3) 13,30,13
   13 CALL SGRAD (GRAD,TGRAD)
      DERIV(LL)=GRAD/DPA
      T3=AP*DPA*DERIV(LL)
      GO TO 32
   30 T3=0.
   32 RHOM=ALPHA3*C4*EXP(-CGM/TEMP)
      T1=PRES*WMAV/(R*TEMP*G)
      T2=RHOM*DELA
      DHDZ(LL)=-H4/G*(T2+T4)-H3/G*T3-FC/G*(H-HF)
C     KFLAG IS SLOPE INDICATOR
C     0-SLOPE MOVING TOWARDS FIRST PEAK
C     1-SLOPE HAS REACHED FIRST PEAK
      IF(KFLAG.EQ.1) GO TO 4000
      Z1=-H4/(ENMX3*DHDZ(LL))
      Z2=.05*(ZEND-Z(LL))
      IF(Z(LL)*(1.-Z1/Z2)) 4060,4060,15
   15 DTDZ=DHDZ(LL)/CAVG
 4000 RHO=T1*G
      W1=C1/RHO
      W2=C2/RHO
      W3=C3/RHO
      W4=C4/RHO
      S1=1./G
      S5=FC/G
      DW4DZ=S1*(FC-T2-T4)-C4*S5
      DW3DZ=S1*(T2*WM3/WM4+T4*WM3/WM4-T3)-C3*S5
      DW2DZ=S1*(.5*T2*WM2/WM4+.5*T4*WM2/WM4+.5*T3*WM2/WM3)-C2*S5
      DW1DZ=S1*(.5*T2*WM1/WM4+.5*T4*WM1/WM4+1.5*T3*WM1/WM3)-C1*S5
      SUMWM=W1/WM1+W2/WM2+W3/WM3+W4/WM4
      SMUDZ=DW1DZ/WM1+DW2DZ/WM2+DW3DZ/WM3+DW4DZ/WM4
      DWMDZ=WMAV/SUMWM*SMUDZ
      DPDZ=-(DELA-1.)/DELA**3*(1.75+75.*VIS*(1.-DELA)/(A*G))*G**2/
     * (64.4*A*RHO)
      DPDZ=DPDZ/144.
      DROZDZ=DWMDZ/WMAV-DTDZ/TEMP+DPDZ/PRES
      T5=FC/G-DROZDZ
      DC4DZ=T1*(FC-T2-T4)-C4*T5
      DC3DZ=T1*(T2*WM3/WM4+T4*WM3/WM4-T3)-C3*T5
      DC2DZ=T1*(.5*T2*WM2/WM4+.5*T4*WM2/WM4+.5*T3*WM2/WM3)-C2*T5
      DC1DZ=T1*(.5*T2*WM1/WM4+.5*T4*WM1/WM4+1.5*T3*WM1/WM3)-C1*T5
      IF (KFLAG.EQ.0) GO TO 16
C     JFLAG IS DZ INDICATOR FOR NON-ZERO FEED RATE CASES
C     =0 DZ INCREMENT O.K.
C     =1 INCREMENT INITIALLY TOO SMALL
      IF(JFLAG.EQ.1) GO TO 93
   90 IF (KOUNT.EQ.4.OR.KOUNT.EQ.6.OR.KOUNT.EQ.8.OR.KOUNT.EQ.10.OR.KOUNT.
     * EQ.12.OR.KOUNT.EQ.14)NINT=1
      KOUNT=KOUNT+1
      DZ=DELTAZ/(THREE**NINT)
      IF (FC) 98,98,93
   98 IF(IFC.EQ.8) GO TO 16
C     IF FEED RATE IS NON-ZERO WE MUST MAKE ADDITIONAL CHECKS ON STEP
C     SIZE OF Z
   93 IF(ABS(DTDZ)*DZ.GT..01*TEMP) GO TO 19
C     CHECK IF WE HAVE REACHED THE END OF THE INJECTOR
      IF((1.+DZ/(Z(LL)-ZO)+.01*ZO/ABS(Z(LL)-ZO)).GT.0.) GO TO 16
   19 DZ1=DZ
      CALL REDIVD (DZ1,DTDZ,NINT,JFLAG,I,LL)
      WRITE (6,91) KOUNT,NINT
   91 FORMAT (//7H KOUNT=,I2,37H THIS INTERVAL HAS BEEN REDIVIDED,I4,
     X 6H TIMES)
   16 H=H+DHDZ(LL)*DZ
 4051 IF (H.LT.HV) GO TO 106
      TEMP=TEMP+DTDZ*DZ
      PRES=PRES+DPDZ*DZ
      C4=C4+DC4DZ*DZ
      C3=C3+DC3DZ*DZ
      C2=C2+DC2DZ*DZ
      C1=C1+DC1DZ*DZ
      SUM=C1/WM1+C2/WM2+C3/WM3+C4/WM4
      IF(C4.LT.0.) SUM=SUM-C4/WM4
      IF(C3.LT.0.) SUM=SUM-C3/WM3
      FRAC1=C1/(WM1*SUM)
      FRAC2=C2/(WM2*SUM)
      FRAC3=C3/(WM3*SUM)
      FRAC4=C4/(WM4*SUM)
      FRAC3D=(FRAC1/FRAC2-1.)/(3.-FRAC1/FRAC2)
      IF (MFLAG.EQ.1) GO TO 500
C     IF RELATIVE DIFFERENCE OF SUCCESSIVE FRAC3D'S IS GREATER THAN 5
C     PERCENT WE RECALCULATE WITH SMALLER DZ INCREMENT
   17 IF((FRAC3D-PFRC3D).LT..05) GO TO 500
   18 H=H-DHDZ(LL)*DZ
      TEMP=TEMP-DTDZ*DZ
      PRES=PRES-DPDZ*DZ
      C4=C4-DC4DZ*DZ
      C3=C3-DC3DZ*DZ
      C2=C2-DC2DZ*DZ
      C1=C1-DC1DZ*DZ
      DZ=DZ/2.
      GO TO 16
  500 PFRC3D=FRAC3D
      IF (C4) 70,71,71
   70 C4=0.
      FRAC4=0.
   71 IF (C3) 72,73,73
   72 C3=0.
      FRAC3=0.
   73 LL=LL+1
      Z(LL)=Z(LL-1)+DZ
      IF (JFLAG.EQ.1) NINT=NINT-1
      IF(NINT.EQ.0) JFLAG=0
      WRITE (6,4059)
 4059 FORMAT (//12H Z ,10X,4HTEMP,7X,4HPRES,7X,1HH,10X,2HC1,9X,2HC2,
     X 9X,2HC3,9X,2HC4)
      WRITE (6,4050) Z(LL),TEMP,PRES,H,C1,C2,C3,C4
 4050 FORMAT (1X,E15.8,1X,E15.8,1X,E15.8,1X,E15.8,1X,E15.8,1X,
     1 E15.8,1X,E15.8,1X,E15.8///)
      WRITE (6,37)
   37 FORMAT (98H MFRAC1      MFRAC2      MFRAC3      MFRAC4
     1     FRAC3D)
      WRITE (6,38) FRAC1,FRAC2,FRAC3,FRAC4,FRAC3D
   38 FORMAT (20X,E15.8,1X,E15.8,1X,E15.8,1X,E15.8,1X,E15.8 //)
      IF(Z(LL).GT.ZBOUND) GO TO 1
      IF (KOUNT.GT.15.AND.JFLAG.EQ.0) GO TO 1
      INJECT=0
      GO TO 3990


















